#!/bin/bash

../setup.sh

make

# mount the bpf FS
mount -t bpf none /sys/fs/bpf

mount -o remount,rw /sys/fs/cgroup/
mkdir /sys/fs/cgroup/unified 
mount -t cgroup2 none /sys/fs/cgroup/unified

# create a test cgroup2
mkdir /sys/fs/cgroup/unified/test.slice

# loading the program
#./bpftool prog load ./ebpf_hhf.o /sys/fs/bpf/hhf_acc type cgroup/skb
./bpftool prog load ./ebpf_socks_hhf.o /sys/fs/bpf/hhf_socks type sockops 
#./bpftool prog load ./tcp_basertt_kern.o /sys/fs/bpf/prog type sockops 

SOCKOPTID=`./bpftool prog  | grep handle_sockop | awk '{print $1} ' | sed -e 's/://g'`

# attaching th program to the egress path of the cgroup FIXME id
#./bpftool cgroup attach /sys/fs/cgroup/unified/test.slice/ egress id 3 multi
./bpftool cgroup attach /sys/fs/cgroup/unified/test.slice/ sock_ops id $SOCKOPTID multi
#./bpftool cgroup attach /sys/fs/cgroup/unified/test.slice/ sock_ops id 6 multi

echo $PPID > /sys/fs/cgroup/unified/test.slice/cgroup.procs 

./bpftool map update id 1 key 00 00 00 00 value 0x00 0x08 0x04 0x03 0x03 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x04 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x05
./bpftool map update id 1 key 01 00 00 00 value 0x00 0x08 0x04 0x03 0x03 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x06 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x07 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x08
./bpftool map update id 1 key 02 00 00 00 value 0x00 0x08 0x04 0x03 0x03 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x09 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0A 0xfc 0x11 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0B
